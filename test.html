<!DOCTYPE html>
<html>
<head>
    <title>WGL</title>
    <meta charset="utf-8">

    <style>
        * { padding: 0; margin: 0; box-sizing: border-box; }

        body { background-color: #000; }

        #renderer {
            width: 100%; height: 100%;
            position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;
            border: 10px solid yellow;
            border-radius: 20px;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <canvas id="renderer"></canvas>

    <script src="gl-matrix.js"></script>
    <script src="dx.js"></script>
    <script src="animation-context.js"></script>
    <script src="graded_shape.js"></script>
    <script>
        // init

        const canvas = document.getElementById("renderer");
        const gl = canvas.getContext("webgl2");

        const dx = DX(gl);
        const ac = AnimationContext(gl, {keyboardView: true, mouseView: true});

        VerTexShape.init(dx);
        gradedProgram.init(dx);


        // shape

        const palette = [
            [
                [255,  255,    0,  255], [255,    0,    0,  255],
                [  0,  255,    0,  255], [  0,    0,  255,  255]
            ],
            2, 2
        ];

        // colors
        const y = [0,0], r = [1,0], g = [0,1], b = [1, 1];


        //vertices
        const p = 50;

        var objMat = mat4.fromTranslation(mat4.create(), [0,-2*p,0]);


        ac.panWorld(6);


        const vertices = [
            [-5*p, 0, 0], [5*p, 0, 0], [-5*p, 0, -10*p], [5*p, 0, -10*p], // s0
            [-4*p, 0, 0], [4*p, 0, 0], [-4*p, 0,  -8*p], [4*p, 0,  -8*p], // s0-1

            [-5*p, p, 0], [5*p, p, 0], [-5*p, p, -10*p], [5*p, p, -10*p], // s1
            [-4*p, p, 0], [4*p, p, 0], [-4*p, p,  -8*p], [4*p, p,  -8*p], // s1-1

        ];

        const triangles = [
            [[4, 5, 6], [b]], [[6, 5, 7], [b]],

            [[4, 6,  8], [b]], [[ 8, 6, 10], [b]],
            [[6, 7, 10], [g]], [[10, 7, 11], [g]],
        ];


        const shape = VerTexShape(vertices, palette, triangles);


        // drawing
        const deg = Math.PI / 180;

        const {
            worldMatrix, cameraMatrix, viewMatrix, perspectiveMatrix, projectionMatrix
        } = ac;

        const lightMatrix = mat4.fromRotation(mat4.create(), 45*deg, [1, 0, 1]);

        const pjMat = mat4.create();
        const lMat = mat4.create();

        function draw (origin) {

            if (origin) mat4.multiply(pjMat,
                perspectiveMatrix,
                mat4.multiply(pjMat,
                    cameraMatrix,
                    mat4.multiply(pjMat,
                        mat4.getRotationMatrix(pjMat, worldMatrix),
                        objMat
                    )
                )
            );

            else mat4.multiply(pjMat, projectionMatrix, objMat);

            mat4.multiply(lMat,
                lightMatrix,
                mat4.getRotationMatrix(lMat, mat4.multiply(lMat, viewMatrix, objMat))
            );

            dx.draw(shape, gradedProgram, {projectionMatrix: pjMat, lightMatrix: lMat});
        }


        ac.setRender(function (deltaAnimationTime) {
            dx.clear();
            draw();
        });

        ac.updateProjection();
        ac.render(); //ac.startAnimation();

    </script>
</body>
</html>